<!DOCTYPE html>
<html> 
<head> 
	<title>Not Alone</title>
	<style type="text/css">
		#hand, #stats, #played, #marker {
			color: blue;
			position: absolute;
			left: 7%;
			top: 60%;
		}

		img {
			padding: 8px;
			cursor: pointer;
			/*width: 18%;*/
		}

		#played{
			border: solid;
			left: 5%;
			width: 90%;
			height: 235px;
			color: black;
			/*text-align: right;*/
			top: 30%;
			font-size: 30px;
		}

		#played img, #marker img {
			cursor: initial;
		}

		#stats, #marker{
			top: 5%;
			font-size: 66px;
		}

		#marker {
			left: 67%;
		}

		#marker img {
			width: 200px;
		}
	</style>	
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
	<script type="text/javascript">
		// Began 3:30pm 18/1/21
		// Began card #2 function 4:30am 19/1/21
		// Added creature and began card #4 function 5:40am
		// Added card #1 and cont card #4 image 6:15am
		// Added card #5, card #6 and card #8 functions 7:10am 
		// TODO 7, 9, 10, 3
		const cards = ['lair', 'jungle', 'river', 'beach', 'rover'];
		const reserve = ['swamp', 'shelter', 'wreck', 'source', 'artefact'];
		let hand = [], played = [];
		let will = 3, ass = 0, res = 0, caught = false, marker = false;
		var lurked, prevChosen, creatureMoved, swamped=0, resized = false;
		
		$(document).ready( function(){ init(); }); 

		function init(){
			hand = hand.concat(cards);
			displayHand();
		}

		function displayHand(){ document.getElementById('hand').innerHTML = '';
			if(!hand.length) { lostwill();
				hand = hand.concat(played);
				played = [];
			}
			for (var i = 0; i < hand.length; i++) {
				var newcard = document.createElement('img');
				newcard.src = 'images/' + hand[i] + '.png';
				newcard.onclick = function() {play(this.src);}
				document.getElementById('hand').append(newcard);
			}
		}

		function displayPlayed(){ document.getElementById('played').innerHTML = '';
			for (var i = 0; i < played.length; i++) {
				var newcard = document.createElement('img');
				newcard.src = 'images/' + played[i] + '.png';
				document.getElementById('played').append(newcard);
			}
		}

		function updateDisplay(){displayHand(); displayPlayed();}

		function updateStats(){
			document.getElementById('stats').innerHTML = 'Will: ' +will+ '/3<br> Assimilation: ' +ass+ '/7<br> Rescue: ' + res +'/13';

			if(will<=0) setTimeout(lostwill, 300);
			if(ass>=7) alert("You were assimilated. You lose..");
			if(res>=13) alert("You were rescued! YOU WIN!");
		}

		function lostwill() { ass++; will=3;
			alert("You lost all your will! Assimilation increases...");
			updateStats();
		}

		function play(name){ //let currHtml = this.innerHTML;
			let fixedName = name.slice(name.indexOf('images/')+7, -4);
			console.log('You played '+ fixedName); // 45, -4
			
				// Player moves
				let chosen = hand.splice(hand.indexOf(fixedName), 1);
				played.push(chosen.toString());
	
				// Creature moves
				if(!creatureMoved) moveCreature();
		
				// CHeck for creature caught player
				if(chosen == lurked) { caught = true;
					alert("The creature caught you! Lose 1 Will.");
					will--; 
					if (lurked == 'lair') {will--;
						alert("The creature caught you in its LAIR! Lose 1 EXTRA Will.");
					}
				}
	
				updateStats();
				updateDisplay();
				if(!caught) setTimeout(action, 200);
			// }
			caught = false;
			prevChosen = chosen;
			creatureMoved = false;
		}

		function moveCreature(){ creatureMoved = true;
			var creature = Math.floor(Math.random()*hand.length);
			lurked = hand[creature].toString();
			alert("The creature was in the "+lurked);
		}

		function action(){ let word = played[played.length-1]; var foundCard;
			if(word == "jungle" && played.length>1){ let found = false;
				do {let input = parseInt(prompt('Which number would you like returned to your hand?'));
					if (input==2) alert('Cannot pick 2.');
					else {for (var i = 0; i < played.length; i++) {
								if (played[i] == cards[input-1] || played[i] == reserve[input-6]) {found=true;
									foundCard = played.splice(i, 1);
									played.splice(played.indexOf('jungle'), 1);
								}
							}
							if (!found) alert('Could not find matching played card number ' + input);
						}
				} while (!found)
			
				// Card found. return it to hand along with 2
				if(!hand.includes('jungle')) hand.push('jungle');
				hand.push(foundCard.toString());
				updateDisplay();
			}

			else if (word == "beach"){
				if (marker) { marker = false;
					document.getElementById('marker').innerHTML = '';
					res++;
					updateStats();
				}
				else {marker = true; 
					var newmark = document.createElement('img');
					newmark.src = 'images/pawn.png';
					document.getElementById('marker').append(newmark);
				}
			}

			else if (word == "rover"){ 
				if (reserveLeft()) {var rover =1; // 0 to cancel
					while (rover < 6 || rover > 10 || hand.includes(reserve[rover - 6]) || played.includes(reserve[rover - 6])) rover = parseInt(prompt("Which card number would you like to add?"));
					if(rover != 0) hand.push(reserve[rover - 6].toString());
					displayHand();
				}
			}

			else if(word == "lair"){
				if(confirm("Would you like to copy the power of the creature's location?")){
					alert("Copied power of the "+lurked);
					played.push(lurked);
					action();
					played.pop();
				}
				else {alert("Returning all cards from discard pile."); 
					for (var i = 0; i < played.length-1; i++) {
						hand.push(played[i]);
					}
					played = ['lair'];
					updateDisplay();
				}
			}

			else if(word == 'swamp' && played.length>1){let found = false;
				do {let input = parseInt(prompt('Which number would you like returned to your hand?'));
					if (input==6) alert('Cannot pick 6.');
					else {for (var i = 0; i < played.length; i++) {
								if (played[i] == cards[input-1] || played[i] == reserve[input-6]) {
									found=true;
									foundCard = played.splice(i, 1);
									played.splice(played.indexOf('swamp'), 1);
								}
							}
							if (!found) alert('Could not find matching played card number ' + input);
						}
				} while (!found)
			
				// Card found. return it to hand then play action again
				hand.push(foundCard.toString());
				if(!hand.includes('swamp')) hand.push('swamp');
				updateDisplay();
				swamped++;
				if (swamped%2 == 1) {	
					played.push('swamp');
					action();
					played.pop();}				
			}

			else if(word == 'wreck') {res++; updateStats();}

			else if(word == 'source') {
				if(confirm("Would you like to regain 1 Will?")) {
					if (will<3) { will++; updateStats(); }
				}
				else alert("Drawing 1 Survival card."); 
			}

			else if(word == 'shelter') alert("Drawing 2 Survival cards. Choose one.");

			else if(word == 'river' || word == 'artefact') {
				const cardSelect = document.querySelectorAll('img');
				cardSelect.forEach(card => {
					card.onclick = select;
				})
				document.getElementById('cardList').onclick = resizeCardlist;
			}

			else console.log(word+' card action not implemented');
		}

		function select() {
			this.style.background = 'tomato';
			setTimeout(selectResolve, 300);
		}

		function selectResolve() { 
			const cardSelect = document.getElementById('hand').children;
			let selected = 0, selectArray=[];
			for (var i = 0; i < cardSelect.length; i++) {
				if (cardSelect[i].style.background == 'tomato') {selected++;
					let cardName = cardSelect[i].src;
					selectArray.push(cardName.slice( cardName.indexOf('images/')+7, -4 ));}
			}
			
			if(selected==2) {
				let choice = confirm('Would you like to select ['+selectArray+ '] as your choices for the '+prevChosen +' card?' );
						if(choice) { moveCreature(); //alert('You selected '+selectArray);
							if(prevChosen == "river"){ let chooseOne;
								while(!hand.includes(chooseOne))
								chooseOne = prompt('Which card would you like to play?');
								// hand[hand.indexOf(cards[chooseOne-1])]
								play('images/'+ chooseOne +'.png'); // will not work online
							}
							else if (prevChosen == "artefact") {
								play('images/'+selectArray[0] +'.png');
								creatureMoved = true;
								play('images/'+selectArray[1] +'.png');
							}
						}
		
						const cardSelect = document.querySelectorAll('img');
						cardSelect.forEach(card => {
							if(choice) card.onclick = function() {play(this.src, this);}
							card.style.background = 'initial';
						})
						document.getElementById('cardList').onclick = resizeCardlist;
					}
		}

		function reserveLeft(){ let check=0;
			for (var i = 0; i < reserve.length; i++) {
				if (hand.includes(reserve[i]) || played.includes(reserve[i]))
					check++;
			}
			if(check==5) return false;
			return true;
		}

		function resizeCardlist(){ resized = !resized;
			if(resized)	document.getElementById('cardList').style.width = '10%';
			else document.getElementById('cardList').style.width = '100%';
		}
	</script>
</head>
<body>
<span id="stats">Will: 3/3<br> Assimilation: 0/7<br> Rescue: 0/13</span>
<div id="marker"></div>
<div id="played">Played</div>
<div id="hand"></div>
<img src="images/allcards.png" id="cardList" style="position: absolute; width: 10%; right: -1%;" onclick="resizeCardlist();">
</body>
</html>
